---
.deploy_base:
  image: python:3.12
  before_script:
    - mkdir -p ~/.ssh && chmod 700 ~/.ssh
    - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config && chmod 600 ~/.ssh/config
  
    - echo "$ENV_PRIVATE_KEY_BASE64" | base64 -d > ~/.ssh/id_rsa 
    - chmod 400 ~/.ssh/id_rsa

    - echo "$ENV_PRIVATE_KEY_BETA_BASE64" | base64 -d > ~/.ssh/id_rsa 
    - chmod 400 ~/.ssh/id_rsa

  
    - ssh-agent sh -c "ssh-add ~/.ssh/id_rsa"
    - ssh-keyscan -H "$ENV_SSH_HOST" >> ~/.ssh/known_hosts
    - echo "$ENV_FILE_BASE64" | base64 -d > $CI_PROJECT_DIR/.env

.deploy:
  stage: deploy
  extends:
    - .deploy_base
  before_script:
    - !reference [.deploy_base, before_script]
    - pip install ansible
    - echo "$ANSIBLE_HOSTS_BASE64" | base64 -d > $CI_PROJECT_DIR/deploy/ansible/inventory/hosts.ini
    - echo "$ANSIBLE_SECRETS_BASE64" | base64 -d > $CI_PROJECT_DIR/deploy/ansible/secrets.yml
    - ansible-galaxy install -r $CI_PROJECT_DIR/deploy/ansible/requirements.yml
  script:
    - ansible-playbook -i $CI_PROJECT_DIR/deploy/ansible/inventory/hosts.ini $CI_PROJECT_DIR/deploy/ansible/playbook.yml

.deploy_legacy:
  stage: deploy
  extends:
    - .deploy_base
  before_script:
    - apt-get update -y && apt-get install -y rsync openssh-client
    - !reference [.deploy_base, before_script]
  script:
    - rsync -avz --delete --exclude=".git" --exclude=".gitlab-ci.yml" ./ $ENV_SSH_USER@$ENV_SSH_HOST:/home/student/app
    - ssh $ENV_SSH_USER@$ENV_SSH_HOST "
        cd /home/student/app/deploy/docker &&
        docker compose down &&
        docker compose -f docker-compose.prod.yml --env-file=../../.env up -d --build
      "

deploy:
  stage: deploy
  only:
    - main
    - master
  extends:
    - .deploy
