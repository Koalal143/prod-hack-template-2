.build:
  image: docker:24.0.5
  stage: build
  services:
    - docker:24.0.5-dind
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""
    IMAGE_TAG: $CI_COMMIT_SHA
    IMAGE_NAME: $CI_REGISTRY_IMAGE/backend:$IMAGE_TAG
  before_script:
    - docker info
    - docker buildx version
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
    - docker buildx create --use --name mybuilder || docker buildx use mybuilder
  script:
    - docker buildx build 
        --file backend/Dockerfile
        --build-arg MODE=prod
        --cache-to=type=registry,ref=$IMAGE_NAME,mode=max
        --cache-from=type=registry,ref=$IMAGE_NAME
        --push
        --tag $IMAGE_NAME
        backend/
